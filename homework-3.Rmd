---
title: "Homework-3 - Stats 519"
author: "Aji John"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


#Problem 8

Problem 8 (8 points). Perform an analysis of the atmospheric carbon dioxide (CO2) time series from Mauna Loa, Hawaii, along the same lines as the analysis of the accidental deaths (AD) series starting with lecture overhead III–82 (the 3rd set of R code on the course Web site has the code used to analyze the AD series). You can read the CO2 data directly into R using co2 <- read.table("http://faculty.washington.edu/dbp/s519/Data/co2-1958-2017.txt").

Please feel free to alter choices that were made in the analysis of the AD series if you deem them to be inappropriate for your analysis of the CO2 series. Create and turn in plots that correspond to overheads III–85, III–87, III–89 (but just show the seasonal pattern for a single year, as is done in III-107), III–92, III–94, III–96, III–97 andIII–98, along with brief descriptions of the steps you took in your analysis (please also turn in the code you used to do your analysis). Finally, state briefly your conclusions about how well the simple modeling approach worked for the CO2 series.

### 


```{r,echo=TRUE,include=TRUE}
co2 <- read.table("http://faculty.washington.edu/dbp/s519/Data/co2-1958-2017.txt")
str(co2)
### define function to do filtering ...

filter.with.padding <- function(x,the.filter,iter=1)
{
    q <- (length(the.filter)-1)/2
    n <- length(x)
    w <- stats::filter(c(rep(x[1],q),x,rep(x[n],q)),the.filter)[(q+1):(q+n)]
    if(iter > 1) for(i in 2:iter) w <- filter(c(rep(w[1],q),w,rep(w[n],q)),the.filter)[(q+1):(q+n)]
    return(w)
}

plot.ACFest <- function(ts, main=NULL, n.lags=40)
{
    ts.acf <- acf(ts, lag.max=n.lags, plot=FALSE)
    n.ts <- length(ts)
    xs <- 1:n.lags
    ys <- ts.acf$acf[2:(n.lags+1)]
    plot(xs,ys,typ="h",xlab="h  (lag)",ylab="ACF",ylim=c(-1,1),col="blue",main=main)
    points(xs,ys,col="red",cex=0.5)
    xs <- 1:n.lags
    xs[1] <- xs[1] - 0.25
    xs[n.lags] <- xs[n.lags] + 0.25
    lines(xs,1.96*sqrt(n.ts-xs)/n.ts,col="magenta",lty="dashed")
    lines(xs,-1.96*sqrt(n.ts-xs)/n.ts,col="magenta",lty="dashed")
    abline(h=0,lty="dashed")
    CI.hw <- 1.96/sqrt(n.ts)
    lines(c(0.75,n.lags+0.25),rep(CI.hw,2),col="blue",lty="dashed")
    lines(c(0.75,n.lags+0.25),rep(-CI.hw,2),col="blue",lty="dashed")
    return(ts.acf$acf)
}
### overhead III-2

plot(co2$V1,co2$V2,col="blue",xlab="year",typ="l",
     ylab=expression(x[t]),main=expression(paste("2nd Example: ", CO[2],
                                                 " Series from Mauna Loa, Hawaii")))

```

### III–85 - Seasonal component taken out
#### Use a smoothing filter to take the seasonal component out

```{r,echo=FALSE,include=FALSE}
co2$year <- substring(as.character(co2$V1),1,4)

co2%>% group_by(year) %>% summarise(months=n())

```

Take 5 points before the center, and 5 after, and penalize the extremes.
### III–85

```{r,echo=TRUE,include=TRUE}
co2 <- read.table("http://faculty.washington.edu/dbp/s519/Data/co2-1958-2017.txt")

m.hat.co2 <- filter.with.padding(co2$V2,c(1/24,rep(1/12,11),1/24))

plot(co2$V1,co2$V2,col="blue",xlab="year",typ="b",ylab=expression(paste(x[t]," and ", hat(m)[t]," (ppm)")),main="Monthly CO2 Values",cex=0.5)
lines(co2$V1,m.hat.co2,col="red",lwd=2)

```
### III–87

```{r,echo=TRUE,include=TRUE}

co2.u <- co2$V2 - m.hat.co2

plot(co2$V1,co2.u,col="blue",xlab="year",typ="b",ylab=expression(paste(u[t]==x[t]-hat(m)[t]," (ppm)")),main="Preliminary Detrending of CO2 Series",cex=0.5)
points(co2$V1[seq(8,696,12)],co2.u[seq(8,696,12)],pch=16,col="red",cex=0.6)



```
### III–89

```{r,echo=TRUE,include=TRUE}


co2.w.j <- rowMeans(matrix(co2.u,nrow=12))

plot(1:12,co2.w.j- mean(co2.w.j),col="blue",xlab="year",
     typ="b",ylab=expression(hat(s)[j]),
     main=expression(paste("CO2 Step 3: Form Estimate {",hat(s)[j],"} of Seasonal Pattern")),
     ylim=c(-9,9),cex=0.5)


```

###  III–92 (Deasonalized data with trend estimate)

```{r,echo=TRUE,include=TRUE}

#get all the years(columns), rows(minths)
#average all the jan, feb... dec
co2.w.j <- rowMeans(matrix(co2.u,nrow=12))
co2.s.j.hat <- rep(co2.w.j - mean(co2.w.j),59)
co2.d <- co2$V2 - co2.s.j.hat

co2.d.reg <- lm(co2.d ~ co2$V1 + I(co2$V1^2))

plot(co2$V1,co2.d,col="blue",xlab="year",typ="b",
     ylab=expression(paste(d[t] == x[t] - hat(s)[t]," and ", hat(m)[t]," (thousands)")),
     main=expression(paste("Deseasonalized Data {", d[t], "} and Trend Estimate {",hat(m)[t],"}")),
     cex=0.5)
lines(co2$V1,fitted(co2.d.reg),col="purple",lwd=2)

```
### III–94 Residuals removed

```{r,echo=TRUE,include=TRUE}

plot(co2$V1,resid(co2.d.reg),col="blue",xlab="year",typ="b",
     ylab=expression(paste(r[t] == x[t] - hat(m)[t] - hat(s)[t]," (ppm)")),
     main=expression(paste("Residuals {",r[t],"} from Removal of {", hat(m)[t],"} and {",hat(s)[t],"}")),
     cex=0.5)

```

### III–96

** Fails null hypothesis 
** Any lag, it is correlated

```{r,echo=TRUE,include=TRUE}

phi <- plot.ACFest(resid(co2.d.reg), 
                   expression(paste("Sample ACF for {", r[t],"}")))[2]

```



### III–97 

```{r,echo=TRUE,include=TRUE}

co2.z <- resid(co2.d.reg)[-1] - phi*resid(co2.d.reg)[-length(resid(co2.d.reg))]

plot(co2$V1[-1],co2.z ,col="blue",xlab="year",
     typ="b",ylab=expression(paste(z[t]==r[t]-hat(phi)*r[t-1]," (thousands)")),
     main=expression(paste("Residuals ",z[t]==r[t]-hat(phi)*r[t-1]," from Fitted AR(1) Model")),
     cex=0.5)

```
### III–98

ACF for residuals from the fitted AR(1) model

```{r,echo=TRUE,include=TRUE}

plot.ACFest(co2.z, expression(paste("Sample ACF for {", z[t],"}")))[2]

```

#Problem 9

Problem 9 (8 points). Here we consider a time series {xt} measuring ambient noise in the ocean from one second to the next. You can read this series directly into R using
on.ts <- scan("http://faculty.washington.edu/dbp/s519/Data/ocean-noise.txt").

Alteratively, you can access the data either via a link on item 15 in the list on the Data page of the course Web site or by going directly to http://faculty.washington.edu/dbp/s519/Data/ocean-noise.txt

Create plots of (a) the time series {xt}, (b) its unit-lag scatter plot (i.e., xt+1 versus xt) and (c) its sample ACF out to lag 20, along with lines showing 95% confidence intervals for the ACF under the null hypothesis that {xt} is a realization of an IID noise process. Examine the null hypothesis by subjecting {xt} to the portmanteau, turning point, difference-sign, rank and runs tests. State the results of each test and your overall conclusion about the viability of the IID noise hypothesis. How do these formal tests compare with the informal test given in your plot of the sample ACF? (The 4th set of R code on the course Web site has code used to compute the five tests for the examples considered in the course overheads.)

### (a) Ocean noise time series

```{r,echo=TRUE,include=TRUE}
onoise <- read.table("http://faculty.washington.edu/dbp/s519/Data/ocean-noise.txt")

onoise$t <- 1:128
str(onoise)
### define function to do filtering ...



plot(onoise$t,onoise$V1,col="blue",xlab="Second",typ="l",
     ylab=expression(x[t]),main=expression(paste("Ocean ",
                                                 " Ambient noise /s")))

```
### (b) Ocean noise unit-lag scatter 

#### Part i
```{r,echo=TRUE,include=TRUE}
onoise.reg <- lm(onoise$V1 ~ onoise$t)

N.onoise <- length(onoise$t)


plot(onoise$t,onoise$V1 ,col="blue",xlab="year",typ="b",ylab=expression(x[t]),main="Ocen  floor ambient noise",cex=0.5)
lines(onoise$t,fitted(onoise.reg),col="red")



```


#### Part ii

```{r,echo=TRUE,include=TRUE}


plot(resid(onoise.reg)[-N.onoise],resid(onoise.reg)[-1],col="blue",xlab=expression(r[t]),typ="p",ylab=expression(r[t+1]),main=expression(paste("Unit Lag Scatter Plot of Residuals {", r[t],"}")),cex=0.5)


```

### (c) its sample ACF out to lag 20, along with lines showing 95% confidence intervals for the ACF under the null hypothesis that {xt} is a realization of an IID noise process

```{r,echo=TRUE,include=TRUE}


onoise.reg.acf <- plot.ACFest(resid(onoise.reg), expression(paste("Sample ACF for Residuals {", r[t],"}")),20)
hs <- 1:20
lines(hs,onoise.reg.acf[2]^hs)



```
